<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini AI Assistant</title>
    <link rel="stylesheet" href="style.css"> <style>
        /* Gaya dasar untuk chatbox, sesuaikan dengan style.cssmu */
        body { font-family: sans-serif; display: flex; flex-direction: column; min-height: 100vh; margin: 0; background-color: #1a1a2e; color: #e0e0e0; }
        .chat-container { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .message { padding: 10px 15px; border-radius: 20px; max-width: 70%; word-wrap: break-word; }
        .message.user { background-color: #6a0572; align-self: flex-end; }
        .message.ai { background-color: #2b2b4f; align-self: flex-start; }
        .message.error { background-color: #dc3545; color: white; align-self: center; }
        .message img { max-width: 100%; height: auto; border-radius: 10px; margin-top: 5px; }
        .input-area { display: flex; padding: 15px; background-color: #25253e; border-top: 1px solid #3a3a5e; }
        .input-area input[type="text"] { flex-grow: 1; padding: 10px; border-radius: 20px; border: 1px solid #4a4a6e; background-color: #3a3a5e; color: #e0e0e0; margin-right: 10px; }
        .input-area input[type="file"] { display: none; } /* Sembunyikan input file asli */
        .input-area label { cursor: pointer; background-color: #007bff; color: white; padding: 10px 15px; border-radius: 20px; margin-right: 10px; display: flex; align-items: center; justify-content: center; }
        .input-area button { background-color: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 20px; cursor: pointer; }
        .input-area button:disabled { background-color: #cccccc; cursor: not-allowed; }
    </style>
</head>
<body>
    <header style="background-color: #2b2b4f; padding: 15px; text-align: center; border-bottom: 1px solid #3a3a5e;">
        <h1 style="margin: 0; color: #8a2be2;">Gemini AI Assistant</h1>
        <p style="margin: 5px 0 0; font-size: 0.9em; color: #b0b0d0;">Powered by Wanz Xploit</p>
    </header>

    <div class="chat-container" id="chatContainer">
        <div class="message ai">Welcome to Gemini AI Assistant! I'm here to help you. Feel free to ask me anything.</div>
        </div>

    <div class="input-area">
        <input type="file" id="imageUpload" accept="image/*">
        <label for="imageUpload">üñºÔ∏è</label> <input type="text" id="userInput" placeholder="Type your message...">
        <button id="sendBtn">Send üöÄ</button>
    </div>

    <script>
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const chatContainer = document.getElementById('chatContainer');
        const imageUpload = document.getElementById('imageUpload');

        let chatHistory = []; // Untuk menyimpan riwayat teks dan gambar

        // Fungsi untuk menambahkan pesan ke UI chatbox
        function addMessageToChatbox(text, role, imageUrl = null) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', role);
            if (imageUrl) {
                const img = document.createElement('img');
                img.src = imageUrl;
                messageDiv.appendChild(img);
            }
            const textNode = document.createTextNode(text);
            messageDiv.appendChild(textNode);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight; // Scroll ke bawah
        }

        // Fungsi untuk menambahkan indikator loading
        function addLoadingMessage() {
            const loadingDiv = document.createElement('div');
            loadingDiv.classList.add('message', 'ai');
            loadingDiv.id = 'loadingMessage';
            loadingDiv.textContent = 'Typing...';
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return loadingDiv;
        }

        // Fungsi untuk membersihkan input teks
        function clearInput() {
            userInput.value = '';
            imageUpload.value = ''; // Bersihkan input file juga
        }

        // Fungsi untuk memuat riwayat dari LocalStorage
        function loadChatFromLocalStorage() {
            const savedHistory = localStorage.getItem('geminiChatHistory');
            if (savedHistory) {
                chatHistory = JSON.parse(savedHistory);
                chatHistory.forEach(turn => {
                    // Gemini history turn bisa memiliki multiple parts (teks + gambar)
                    const userPart = turn.parts.find(p => p.text);
                    const userImagePart = turn.parts.find(p => p.inlineData);
                    if (userPart) {
                        addMessageToChatbox(userPart.text, 'user', userImagePart ? `data:${userImagePart.inlineData.mimeType};base64,${userImagePart.inlineData.data}` : null);
                    }

                    // Asumsi respons AI selalu teks
                    const modelTurn = chatHistory[chatHistory.indexOf(turn) + 1]; // Cari respons AI setelah giliran user
                    if (modelTurn && modelTurn.role === "model") {
                         addMessageToChatbox(modelTurn.parts[0].text, 'ai');
                    }
                });
            }
        }

        // Fungsi untuk menyimpan riwayat ke LocalStorage
        function saveChatToLocalStorage() {
            localStorage.setItem('geminiChatHistory', JSON.stringify(chatHistory));
        }

        // Fungsi utama untuk mengirim pesan dan/atau gambar
        async function sendMessage(message, imageUrlBase64 = null) {
            if (!message && !imageUrlBase64) return; // Jangan kirim jika kosong

            const userContentParts = [];
            if (message) {
                userContentParts.push({ text: message });
            }
            if (imageUrlBase64) {
                // Mendapatkan mime type dari base64 string
                const mimeType = imageUrlBase64.substring("data:".length, imageUrlBase64.indexOf(";base64"));
                const base64Data = imageUrlBase64.split(',')[1];
                userContentParts.push({
                    inlineData: {
                        mimeType: mimeType, // Contoh: 'image/jpeg', 'image/png'
                        data: base64Data
                    }
                });
            }

            // Tambahkan pesan pengguna (teks + gambar jika ada) ke chatHistory
            chatHistory.push({ role: "user", parts: userContentParts });
            addMessageToChatbox(message, 'user', imageUrlBase64); // Tampilkan di UI

            const loadingMessage = addLoadingMessage();
            sendBtn.disabled = true;

            try {
                // Kirim seluruh riwayat ke backend
                const response = await fetch("/api/generate", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        // Prompt saat ini sudah termasuk dalam chatHistory yang dikirim
                        history: chatHistory // Kirim seluruh history ke server
                    }),
                });

                const data = await response.json();

                if (response.ok && data.response) {
                    const aiResponseText = data.response;
                    // Tambahkan respons AI ke chatHistory
                    chatHistory.push({ role: "model", parts: [{ text: aiResponseText }] });
                    addMessageToChatbox(aiResponseText, 'ai');
                    saveChatToLocalStorage(); // Simpan history setelah ada respons
                } else {
                    const errorMsg = data.error || "Error from server.";
                    addMessageToChatbox(`Error: ${errorMsg}`, 'error');
                    console.error("API Error:", data);
                }
            } catch (error) {
                console.error("Fetch error:", error);
                addMessageToChatbox("Error connecting to the server. Please try again.", 'error');
            } finally {
                if (chatContainer.contains(loadingMessage)) {
                    chatContainer.removeChild(loadingMessage);
                }
                sendBtn.disabled = false;
                clearInput();
            }
        }

        // Event listener untuk input file
        imageUpload.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64Image = reader.result; // Ini adalah Base64 string
                    // Kirim pesan kosong dengan gambar, atau pesan dengan gambar
                    sendMessage(userInput.value, base64Image);
                };
                reader.readAsDataURL(file); // Baca file sebagai Base64
            }
        });

        // Event listener untuk tombol kirim atau Enter
        sendBtn.addEventListener('click', () => {
            sendMessage(userInput.value);
        });

        userInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage(userInput.value);
            }
        });

        // Panggil fungsi loadChatFromLocalStorage saat DOMContentLoaded
        document.addEventListener('DOMContentLoaded', loadChatFromLocalStorage);
    </script>
</body>
</html>
